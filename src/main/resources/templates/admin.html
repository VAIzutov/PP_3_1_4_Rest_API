<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>
    <link rel="stylesheet" href="/webjars/bootstrap/5.3.3/css/bootstrap.min.css">
    <style>
        .navbar-dark {
            background-color: #2d2d2d;
        }

        .sidebar {
            height: 100vh;
            position: fixed;
            top: 56px;
            left: 0;
            width: 200px;
            background-color: #f8f9fa;
            border-right: 1px solid #dee2e6;
            padding-top: 20px;
        }

        .content {
            margin-left: 200px;
            padding: 20px;
        }

        .nav-link.active {
            background-color: #0d6efd;
            color: white !important;
        }

        .btn-edit {
            background-color: #008b8b;
            color: white;
            border: none;
        }

        .btn-edit:hover {
            background-color: #006666;
        }

        .btn-delete {
            background-color: #dc3545;
            color: white;
            border: none;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        .modal-body .form-group {
            margin-bottom: 1rem;
        }

        .modal-body label {
            font-weight: bold;
            display: block;
            margin-bottom: 0.25rem;
        }

        .modal-body input, .modal-body select {
            width: 100%;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
        }

        .modal-footer .btn {
            min-width: 80px;
        }

        .form-control-yellow {
            background-color: #fff3cd;
        }

        .logout-btn {
            color: #6c757d !important;
            background: none !important;
            border: none !important;
            padding: 0.25rem 0.5rem !important;
        }

        .logout-btn:hover {
            color: #495057 !important;
            background: rgba(0, 0, 0, 0.05) !important;
            text-decoration: none !important;
        }

        .nav-link.active {
            color: #000 !important;
        }
    </style>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <span class="navbar-brand">
            <strong id="currentUserName">Loading...</strong> with roles: <span id="currentUserRoles">Loading...</span>
        </span>
        <div class="ms-auto">
            <form action="/logout" method="post" class="d-inline">
                <button type="submit" class="btn btn-sm logout-btn">Logout</button>
            </form>
        </div>
    </div>
</nav>

<div class="sidebar">
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="nav-link active" href="#">Admin</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="/user">User</a>
        </li>
    </ul>
</div>

<div class="content">

    <h1>Admin panel</h1>

    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button">
                Users table
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="add-tab" data-bs-toggle="tab" data-bs-target="#add" type="button">
                New User
            </button>
        </li>
    </ul>

    <div class="tab-content" id="adminTabContent">

        <!-- Users Table Tab -->
        <div class="tab-pane fade show active" id="users" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    All users
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>First Name</th>
                            <th>Last Name</th>
                            <th>Age</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                        </thead>
                        <tbody id="usersTableBody">
                        <!-- Will be filled by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add User Tab -->
        <div class="tab-pane fade" id="add" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    Add new user
                </div>
                <div class="card-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label class="form-label">First name</label>
                            <input type="text" class="form-control form-control-yellow" id="addName" required/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Last name</label>
                            <input type="text" class="form-control form-control-yellow" id="addSurname" required/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Age</label>
                            <input type="number" class="form-control" id="addAge" required min="1"/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control form-control-yellow" id="addUsername" required/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="addPassword" required/>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="addRoleIds" multiple required>
                                <!-- Options will be loaded by JS -->
                            </select>
                        </div>
                        <div class="d-grid gap-2 d-md-flex justify-content-md-center mt-4">
                            <button type="submit" class="btn btn-success">Add new user</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <!-- Edit Modal (один на всех, динамически заполняется) -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit user</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editUserForm">
                    <div class="modal-body">
                        <div class="container" style="max-width: 500px;">
                            <div class="mb-3 text-center">
                                <strong>ID</strong>
                                <div class="mt-1">
                                    <input type="text" class="form-control form-control-sm mx-auto"
                                           style="max-width: 250px;" readonly id="editId"/>
                                </div>
                            </div>
                            <div class="mb-3 text-center">
                                <strong>First name</strong>
                                <div class="mt-1">
                                    <input type="text" class="form-control form-control-sm mx-auto"
                                           style="max-width: 250px;" id="editName" required/>
                                </div>
                            </div>
                            <div class="mb-3 text-center">
                                <strong>Last name</strong>
                                <div class="mt-1">
                                    <input type="text" class="form-control form-control-sm mx-auto"
                                           style="max-width: 250px;" id="editSurname" required/>
                                </div>
                            </div>
                            <div class="mb-3 text-center">
                                <strong>Age</strong>
                                <div class="mt-1">
                                    <input type="number" class="form-control form-control-sm mx-auto"
                                           style="max-width: 250px;" id="editAge" required min="1"/>
                                </div>
                            </div>
                            <div class="mb-3 text-center">
                                <strong>Email</strong>
                                <div class="mt-1">
                                    <input type="text" class="form-control form-control-sm mx-auto"
                                           style="max-width: 250px;" id="editUsername" required/>
                                </div>
                            </div>
                            <div class="mb-3 text-center">
                                <strong>Password</strong>
                                <div class="mt-1">
                                    <input type="password" class="form-control form-control-sm mx-auto"
                                           style="max-width: 250px;" id="editPassword" placeholder="Leave blank to keep current"/>
                                </div>
                            </div>
                            <div class="mb-3 text-center">
                                <strong>Role</strong>
                                <div class="mt-1">
                                    <select class="form-select form-select-sm mx-auto"
                                            style="max-width: 250px;"
                                            id="editRoleIds"
                                            multiple required>
                                        <!-- Options will be loaded by JS -->
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Edit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Modal (один на всех) -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete user</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="container" style="max-width: 500px;">
                        <div class="mb-3 text-center">
                            <strong>ID</strong>
                            <div class="mt-1">
                                <input type="text" class="form-control form-control-sm mx-auto"
                                       style="max-width: 250px; background-color: #e9ecef;" readonly id="deleteId"/>
                            </div>
                        </div>
                        <div class="mb-3 text-center">
                            <strong>First name</strong>
                            <div class="mt-1">
                                <input type="text" class="form-control form-control-sm mx-auto"
                                       style="max-width: 250px; background-color: #e9ecef;" readonly id="deleteName"/>
                            </div>
                        </div>
                        <div class="mb-3 text-center">
                            <strong>Last name</strong>
                            <div class="mt-1">
                                <input type="text" class="form-control form-control-sm mx-auto"
                                       style="max-width: 250px; background-color: #e9ecef;" readonly id="deleteSurname"/>
                            </div>
                        </div>
                        <div class="mb-3 text-center">
                            <strong>Age</strong>
                            <div class="mt-1">
                                <input type="number" class="form-control form-control-sm mx-auto"
                                       style="max-width: 250px; background-color: #e9ecef;" readonly id="deleteAge"/>
                            </div>
                        </div>
                        <div class="mb-3 text-center">
                            <strong>Email</strong>
                            <div class="mt-1">
                                <input type="text" class="form-control form-control-sm mx-auto"
                                       style="max-width: 250px; background-color: #e9ecef;" readonly id="deleteUsername"/>
                            </div>
                        </div>
                        <div class="mb-3 text-center">
                            <strong>Role</strong>
                            <div class="mt-1">
                                <div class="form-control form-control-sm mx-auto text-start"
                                     style="max-width: 250px; background-color: #e9ecef; border: 1px solid #ced4da; padding: 0.25rem;"
                                     id="deleteRolesDisplay">
                                    <!-- Roles will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const usersTableBody = document.getElementById('usersTableBody');
        const addRoleSelect = document.getElementById('addRoleIds');
        const editRoleSelect = document.getElementById('editRoleIds');
        const addUserForm = document.getElementById('addUserForm');
        const editUserForm = document.getElementById('editUserForm');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        let allRoles = [];
        let currentUserIdToDelete = null;

        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/admin/users/current');
                if (response.ok) {
                    const user = await response.json();
                    document.getElementById('currentUserName').textContent = user.username;
                    const rolesStr = user.roles.map(r => r.name).join(' ');
                    document.getElementById('currentUserRoles').textContent = rolesStr;
                }
            } catch (e) {
                console.error('Failed to load current user:', e);
            }
        }

        async function loadRoles() {
            try {
                const response = await fetch('/api/roles');
                if (!response.ok) throw new Error('Roles load failed');
                allRoles = await response.json();

                addRoleSelect.innerHTML = '';
                editRoleSelect.innerHTML = '';

                allRoles.forEach(role => {
                    const opt1 = document.createElement('option');
                    opt1.value = role.id;
                    opt1.textContent = role.name;
                    addRoleSelect.appendChild(opt1);

                    const opt2 = document.createElement('option');
                    opt2.value = role.id;
                    opt2.textContent = role.name;
                    editRoleSelect.appendChild(opt2);
                });
            } catch (e) {
                console.error('Error loading roles:', e);
                alert('Ошибка загрузки ролей');
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (!response.ok) throw new Error('Users load failed');
                const users = await response.json();

                usersTableBody.innerHTML = '';

                users.forEach(user => {
                    const tr = document.createElement('tr');

                    tr.innerHTML = `
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.surname}</td>
                        <td>${user.age}</td>
                        <td>${user.username}</td>
                        <td>${user.roles.map(r => r.name).join(' ')}</td>
                        <td>
                            <button type="button" class="btn btn-edit btn-sm" onclick="openEditModal(${user.id})">Edit</button>
                        </td>
                        <td>
                            <button type="button" class="btn btn-delete btn-sm" onclick="openDeleteModal(${user.id})">Delete</button>
                        </td>
                    `;
                    usersTableBody.appendChild(tr);
                });

            } catch (e) {
                console.error('Error loading users:', e);
                alert('Ошибка загрузки пользователей');
            }
        }

        window.openEditModal = async function(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`);
                if (!response.ok) throw new Error('User not found');
                const user = await response.json();

                document.getElementById('editId').value = user.id;
                document.getElementById('editName').value = user.name;
                document.getElementById('editSurname').value = user.surname;
                document.getElementById('editAge').value = user.age;
                document.getElementById('editUsername').value = user.username;
                document.getElementById('editPassword').value = ''; // clear password field

                Array.from(editRoleSelect.options).forEach(opt => opt.selected = false);
                user.roles.forEach(role => {
                    const option = Array.from(editRoleSelect.options).find(o => o.value == role.id);
                    if (option) option.selected = true;
                });

                const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
                modal.show();
            } catch (e) {
                console.error('Edit modal error:', e);
                alert('Ошибка при открытии модального окна редактирования');
            }
        };

        window.openDeleteModal = async function(userId) {
            try {
                const response = await fetch(`/api/admin/users/${userId}`);
                if (!response.ok) throw new Error('User not found');
                const user = await response.json();

                document.getElementById('deleteId').value = user.id;
                document.getElementById('deleteName').value = user.name;
                document.getElementById('deleteSurname').value = user.surname;
                document.getElementById('deleteAge').value = user.age;
                document.getElementById('deleteUsername').value = user.username;

                const rolesHtml = user.roles.map(r => `<div>${r.name}</div>`).join('');
                document.getElementById('deleteRolesDisplay').innerHTML = rolesHtml;

                currentUserIdToDelete = userId;

                const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
                modal.show();
            } catch (e) {
                console.error('Delete modal error:', e);
                alert('Ошибка при открытии модального окна удаления');
            }
        };

        confirmDeleteBtn.addEventListener('click', async function() {
            if (!currentUserIdToDelete) return;

            try {
                const response = await fetch(`/api/admin/users/${currentUserIdToDelete}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Delete failed');
                loadUsers(); // Обновляем таблицу
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteUserModal'));
                modal.hide();
                currentUserIdToDelete = null;
            } catch (e) {
                console.error('Delete error:', e);
                alert('Ошибка при удалении пользователя');
            }
        });

        addUserForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const newUser = {
                name: document.getElementById('addName').value,
                surname: document.getElementById('addSurname').value,
                age: parseInt(document.getElementById('addAge').value),
                username: document.getElementById('addUsername').value,
                password: document.getElementById('addPassword').value,
                roleIds: Array.from(addRoleSelect.selectedOptions).map(o => parseInt(o.value))
            };

            try {
                const response = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newUser)
                });
                if (!response.ok) throw new Error('Create failed');
                loadUsers();
                addUserForm.reset();
                Array.from(addRoleSelect.options).forEach(opt => opt.selected = false);
                const usersTab = document.getElementById('users-tab');
                const addTab = document.getElementById('add-tab');
                usersTab.classList.add('active');
                addTab.classList.remove('active');
                document.getElementById('users').classList.add('show', 'active');
                document.getElementById('add').classList.remove('show', 'active');
                alert('User created successfully!');
            } catch (e) {
                console.error('Create error:', e);
                alert('Ошибка при создании пользователя');
            }
        });

        editUserForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const userId = parseInt(document.getElementById('editId').value);
            const password = document.getElementById('editPassword').value;
            const updatedUser = {
                name: document.getElementById('editName').value,
                surname: document.getElementById('editSurname').value,
                age: parseInt(document.getElementById('editAge').value),
                username: document.getElementById('editUsername').value,
                roleIds: Array.from(editRoleSelect.selectedOptions).map(o => parseInt(o.value))
            };
            if (password) {
                updatedUser.password = password;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updatedUser)
                });
                if (!response.ok) throw new Error('Update failed');
                loadUsers();
                const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
                modal.hide();
                alert('User updated successfully!');
            } catch (e) {
                console.error('Update error:', e);
                alert('Ошибка при обновлении пользователя');
            }
        });

        loadCurrentUser();
        loadRoles();
        loadUsers();
    });
</script>

</body>
</html>